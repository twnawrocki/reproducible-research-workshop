---
title: "Reproducible Analyses Workshop"
author: "Timm Nawrocki"
date: "May 17, 2018"
output:
  html_document:
    keep_md: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Set Libraries, include=FALSE}
# Install required libraries if they are not already installed.
Required_Packages <- c("devtools", "dplyr", "DT", "ggplot2", "ggpmisc", "kableExtra", "leaflet", "readxl", "remotes", "tidyr")
New_Packages <- Required_Packages[!(Required_Packages %in% installed.packages()[,"Package"])]
if (length(New_Packages) > 0) {
  install.packages(New_Packages)
}

# Import required libraries.
library(devtools)
library(dplyr)
library(DT)
library(ggplot2)
library(ggpmisc)
library(kableExtra)
library(leaflet)
library(readxl)
library(remotes)
library(tidyr)

# Set seed
set.seed(415)

# Set working directory by user input
userDirectory <- choose.dir()
setwd(userDirectory)
```

## Environment Settings

The environment settings for this session are:

```{r environmentSettings, echo=FALSE}
# Print session info to the markdown document
sessionInfo()
```

## Example Plot

The following code produces an example point plot based on random numbers.

```{r examplePlot}
# Create example plot in the markdown document
ggplot(data.frame(x=rnorm(100), y=rnorm(100)), aes(x,y)) +
  geom_point()
data('mpg')
```

## Example Table

The following code produces an example table using the "mpg" dataset.

```{r datatable}
# Import example dataset and output a table in the markdown document
data('mpg')
datatable(mpg, caption='Mileage')
```

## Tidying data using dplyr and tidyr

```{r readCatch}
# Read in csv from url
catch_data = read.csv(url("https://knb.ecoinformatics.org/knb/d1/mn/v2/object/df35b.302.1", method = "libcurl"), stringsAsFactors = FALSE)
```

The pipe function (%>%) takes an initial defined argument and passes it as the first argument in an initial command. For every subsequent command where the pipe is repeated, the output from the last command is input as the first argument in a subsequent command. The final command needs to be stored as a variable.

```{r gatherCatch}
# Select columns for analysis and transpose into a new table shape
catch_data = catch_data %>%
  select(Region, Year, Chinook, Sockeye, Coho, Pink, Chum)

# Gather the data frame and save as a new data frame
catch_gather = gather(catch_data, key = species, value = catch, Chinook, Sockeye, Coho, Pink, Chum)
```

The output table has "gathered" the catch-species columns into a "species" column and a "catch" column. The key specifies the new column name for the column names listed in the arguments and the value specifies the new column name for the values that existed within the columns listed in the arguments.

```{r spreadCatch}
# Spread the gathered data back to its wide form and save as a new data frame
catch_spread = spread(catch_gather, key = species, value = catch, fill = NA)
```

The syntax for spreading the data functions in opposite such that key specifies the column headings to be added and the value parses into those columns.

```{r catchError}
# Add a new column to data frame and multiply by 1000 to correct for units. An error for a non-numeric value in row 401 is corrected by converting to integer.
catch_gather <- catch_gather %>% 
  rename(catch_thousands = catch) %>%
  rename(regionCode = Region) %>%
  mutate(catch_thousands = ifelse(catch_thousands == "I", 1, catch_thousands),
         catch_thousands = as.integer(catch_thousands)) %>%
  mutate(catch = catch_thousands * 1000)
```

```{r summaryTables}
# Example summary by species
catch_species = catch_gather %>%
  group_by(species) %>%
  summarize(catch_mean = mean(catch), num_obs = n())

# Example summary for Chinook salmon by year
catch_chinookYear = catch_gather %>%
  filter(species == 'Chinook') %>%
  group_by(Year) %>%
  summarize(catch_mean = mean(catch), num_obs = n()) %>%
  arrange(desc(mean_catch))
```

```{r readRegions}
# Read in the region names csv from url
region_names <- read.csv(url("https://knb.ecoinformatics.org/knb/d1/mn/v2/object/df35b.303.1", method = "libcurl"), stringsAsFactors = FALSE)
```

```{r joinRegions}
# Select and rename columns from the region_names data frame
region_names = region_names %>%
  select(code, mgmtArea) %>%
  rename(region = mgmtArea) %>%
  rename(regionCode = code)

# Perform a left join to add the full region name to the catch_gather data frame
catch_gather = left_join(catch_gather, region_names, by = c('regionCode' = 'regionCode'))
